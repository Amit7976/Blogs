"use server";
import connect from "@/dbConfig/dbConfig";
import User from "@/models/userModel";
import bcryptjs from "bcryptjs";
import { redirect } from "next/navigation";

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const credentialsSignUp = async (
  firstName: string,
  lastName: string,
  email: string,
  password: string
) => {
  // CONNECT TO THE DATABASE
  try {
    await connect();
  } catch (error) {
    console.error("Failed to connect to the database:", error);
    throw new Error("Internal server error");
  }

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  //console.log("firstName:" + firstName);
  //console.log("lastName:" + lastName);
  //console.log("email:" + email);
  //console.log("password:" + password);

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  let candidate = await User.findOne({ email });
  //console.log(candidate);

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  if (candidate) {
    throw new Error("Email already registered");
  }

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  const salt = await bcryptjs.genSalt(10);
  const hashedPassword = await bcryptjs.hash(password, salt);

  //console.log("hashedPassword:" + hashedPassword);

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  // Create the new candidate and get the result
  //console.log("Create the new candidate and get the result");

  // Create a new candidate
  candidate = await User.create({
    firstName,
    lastName,
    email,
    password: hashedPassword,
  });

  //console.log("candidate fetch data: " + candidate);

  ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  redirect("/auth/login");
};

export { credentialsSignUp };
